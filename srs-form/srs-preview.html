<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SRS Preview - Professional Document</title>
    <link rel="stylesheet" href="srs-style.css">
    <style>
        /* SRS Preview Page Styles */
        .srs-preview-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: var(--space-xl);
            background: #ffffff;
            min-height: 100vh;
        }

        .srs-header {
            text-align: center;
            margin-bottom: var(--space-2xl);
            padding: var(--space-xl);
            background: #f8f9fa;
            border: 2px solid #3498db;
            border-radius: var(--radius-lg);
        }

        .srs-title {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: var(--space-md);
        }

        .srs-subtitle {
            color: #7f8c8d;
            font-size: var(--font-size-lg);
        }

        .document-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-xl);
            border-bottom: 2px solid #3498db;
        }

        .tab-btn {
            padding: var(--space-md) var(--space-lg);
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #7f8c8d;
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-btn:hover {
            color: #2980b9;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .srs-document {
            background: #ffffff;
            border: 2px solid #333333;
            border-radius: 8px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
            color: #333333;
        }

        .srs-document h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 20px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .srs-document h2 {
            color: #2980b9;
            font-size: 1.8rem;
            margin-top: 40px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            font-weight: bold;
            counter-increment: section;
        }

        .srs-document h3 {
            color: #34495e;
            font-size: 1.4rem;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: bold;
            counter-increment: subsection;
        }

        .srs-document h4 {
            color: #7f8c8d;
            font-size: 1.2rem;
            margin-top: 25px;
            margin-bottom: 10px;
            font-weight: bold;
            counter-increment: subsubsection;
        }

        .srs-document p {
            margin-bottom: 15px;
            text-align: justify;
            text-indent: 20px;
        }

        .srs-document ul, .srs-document ol {
            margin-bottom: 20px;
            padding-left: 30px;
        }

        .srs-document li {
            margin-bottom: 8px;
        }

        .srs-document strong {
            color: #2c3e50;
            font-weight: bold;
        }

        .highlight-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            margin: 25px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .document-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: #ecf0f1;
            border-radius: 6px;
            border: 1px solid #bdc3c7;
        }

        .document-header h1 {
            margin-bottom: 20px;
            border: none;
            padding: 0;
        }

        .document-header .project-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .document-header .info-item {
            text-align: left;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .document-header .info-label {
            font-weight: bold;
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }

        .document-header .info-value {
            color: #7f8c8d;
        }

        .requirement-item {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 4px 4px 0;
        }

        .requirement-id {
            font-weight: bold;
            color: #2980b9;
            margin-bottom: 5px;
        }

        .requirement-text {
            color: #2c3e50;
        }

        .table-container {
            margin: 20px 0;
            overflow-x: auto;
        }

        .srs-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
        }

        .srs-table th,
        .srs-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .srs-table th {
            background: #3498db;
            color: white;
            font-weight: bold;
        }

        .srs-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .srs-table tr:hover {
            background: #e3f2fd;
        }

        .page-break {
            page-break-before: always;
        }

        .toc {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }

        .toc h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .toc ul {
            list-style: none;
            padding-left: 0;
        }

        .toc li {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
        }

        .toc li:before {
            content: "‚Ä¢";
            color: #3498db;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .toc a {
            color: #2980b9;
            text-decoration: none;
        }

        .toc a:hover {
            text-decoration: underline;
        }

        /* Numbering for sections */
        .srs-document {
            counter-reset: section subsection subsubsection;
        }

        .srs-document h2:before {
            content: counter(section) ". ";
        }

        .srs-document h3:before {
            content: counter(section) "." counter(subsection) " ";
        }

        .srs-document h4:before {
            content: counter(section) "." counter(subsection) "." counter(subsubsection) " ";
        }

        .action-buttons {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
            margin-top: var(--space-xl);
            padding: var(--space-xl);
            background: #f8f9fa;
            border: 2px solid #3498db;
            border-radius: var(--radius-lg);
        }

        .btn-primary {
            padding: var(--space-md) var(--space-xl);
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: none;
            border-radius: var(--radius-sm);
            color: #ffffff;
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            box-shadow: 0 4px 6px rgba(52, 152, 219, 0.1);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(52, 152, 219, 0.1);
        }

        .btn-secondary {
            padding: var(--space-md) var(--space-xl);
            background: transparent;
            border: 2px solid #3498db;
            border-radius: var(--radius-sm);
            color: #3498db;
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .btn-secondary:hover {
            background: #3498db;
            color: #ffffff;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.3);
        }

        .loading {
            text-align: center;
            padding: var(--space-2xl);
            color: #7f8c8d;
        }
        
        .loading-steps {
            margin-top: 20px;
        }
        
        .loading-steps .step {
            padding: 8px 0;
            color: #666;
            font-size: 14px;
            animation: pulse 2s infinite;
        }
        
        .loading-steps .step:nth-child(1) { animation-delay: 0s; }
        .loading-steps .step:nth-child(2) { animation-delay: 0.5s; }
        .loading-steps .step:nth-child(3) { animation-delay: 1s; }
        .loading-steps .step:nth-child(4) { animation-delay: 1.5s; }
        .loading-steps .step:nth-child(5) { animation-delay: 2s; }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .error {
            text-align: center;
            padding: var(--space-2xl);
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            border-radius: var(--radius-md);
        }

        .test-section {
            text-align: center;
            padding: var(--space-2xl);
        }

        /* Print Styles */
        @media print {
            .action-buttons, .document-tabs, .test-section {
                display: none;
            }
            
            .srs-preview-container {
                max-width: none;
                padding: 0;
            }
            
            .srs-document {
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }
    </style>
</head>
<body>
    <div class="srs-preview-container">
        <div class="srs-header">
            <h1 class="srs-title">üìÑ SRS Document Preview</h1>
            <p class="srs-subtitle">Review your Software Requirements Specification before submission</p>
        </div>

        <div id="loadingMessage" class="loading">
            <h2>‚è≥ Generating SRS Document...</h2>
            <p>Please wait while we create your professional SRS document.</p>
        </div>

        <div id="errorMessage" class="error" style="display: none;">
            <h2>‚ùå Error Loading SRS</h2>
            <p>There was an error generating your SRS document. Please try again.</p>
        </div>

        <div id="testSection" class="test-section" style="display: none;">
            <button id="testBtn" class="btn-secondary">
                <span class="btn-icon">üß™</span>
                <span class="btn-text">Test with Sample Data</span>
            </button>
            <button id="refreshBtn" class="btn-secondary">
                <span class="btn-icon">üîÑ</span>
                <span class="btn-text">Force Refresh & Clear Cache</span>
            </button>
        </div>

        <!-- Document Tabs -->
        <div id="documentTabs" class="document-tabs" style="display: none;">
            <button class="tab-btn active" data-tab="srs">SRS Document</button>
            <button class="tab-btn" data-tab="contract">Project Agreement</button>
            <button class="tab-btn" data-tab="pricing">Pricing & Timeline</button>
            <button class="tab-btn" data-tab="roadmap">Developer Roadmap</button>
            <button class="tab-btn" data-tab="summary">Project Summary</button>
        </div>

        <!-- Document Contents -->
        <div id="documentContent" style="display: none;">
            <div class="tab-content active" id="srs-tab">
                <div id="srsDocument" class="srs-document">
                    <!-- SRS content will be generated here -->
                </div>
            </div>
            
            <div class="tab-content" id="contract-tab">
                <div id="contractDocument" class="srs-document">
                    <!-- Contract content will be generated here -->
                </div>
            </div>
            
            <div class="tab-content" id="pricing-tab">
                <div id="pricingDocument" class="srs-document">
                    <!-- Pricing and timeline content will be generated here -->
                </div>
            </div>
            
            <div class="tab-content" id="roadmap-tab">
                <div id="roadmapDocument" class="srs-document">
                    <!-- Developer roadmap content will be generated here -->
                </div>
            </div>
            
            <div class="tab-content" id="summary-tab">
                <div id="summaryDocument" class="srs-document">
                    <!-- Summary content will be generated here -->
                </div>
            </div>
        </div>

        <div id="actionButtons" class="action-buttons" style="display: none;">
            <button id="printBtn" class="btn-secondary">
                <span class="btn-icon">üñ®Ô∏è</span>
                <span class="btn-text">Print Document</span>
            </button>
            <button id="downloadBtn" class="btn-secondary">
                <span class="btn-icon">üì•</span>
                <span class="btn-text">Download PDF</span>
            </button>
            <button id="submitBtn" class="btn-primary">
                <span class="btn-icon">üìß</span>
                <span class="btn-text">Submit SRS & Get Contract</span>
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="enhanced-gemini.js"></script>
    <script>
        class SRSPreview {
            constructor() {
                this.formData = null;
                this.loadingMessage = document.getElementById('loadingMessage');
                this.errorMessage = document.getElementById('errorMessage');
                this.documentTabs = document.getElementById('documentTabs');
                this.documentContent = document.getElementById('documentContent');
                this.srsDocument = document.getElementById('srsDocument');
                this.contractDocument = document.getElementById('contractDocument');
                this.pricingDocument = document.getElementById('pricingDocument');
                this.roadmapDocument = document.getElementById('roadmapDocument');
                this.summaryDocument = document.getElementById('summaryDocument');
                this.actionButtons = document.getElementById('actionButtons');
                this.submitBtn = document.getElementById('submitBtn');
                this.printBtn = document.getElementById('printBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.testSection = document.getElementById('testSection');
                this.testBtn = document.getElementById('testBtn');
                this.refreshBtn = document.getElementById('refreshBtn');
                
                // Initialize enhanced Gemini service
                this.enhancedGemini = new EnhancedGeminiService();
                
                this.init();
            }

            init() {
                console.log('SRS Preview initialized');
                console.log('Current timestamp:', Date.now());
                console.log('Page URL:', window.location.href);
                
                // Clear any old localStorage data
                this.clearOldData();
                
                this.setupEventListeners();
                this.loadFormData();
            }

            clearOldData() {
                console.log('Clearing old localStorage data...');
                
                // Get the current data key from URL to avoid clearing it
                const urlParams = new URLSearchParams(window.location.search);
                const currentDataKey = urlParams.get('key');
                
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('srs_preview_data_') && key !== currentDataKey) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => {
                    console.log('Removing old key:', key);
                    localStorage.removeItem(key);
                });
                
                console.log('Cleared', keysToRemove.length, 'old entries (preserved current key)');
            }

            loadFormData() {
                try {
                    console.log('=== LOADING FORM DATA ===');
                    console.log('Current URL:', window.location.href);
                    console.log('URL search params:', window.location.search);
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const dataKey = urlParams.get('key');
                    console.log('Data key from URL:', dataKey);
                    
                    if (!dataKey) {
                        console.error('No data key found in URL');
                        this.showError('No data key found in URL. Please go back to the form and try again.');
                        this.testSection.style.display = 'block';
                        return;
                    }
                    
                    console.log('Looking for data in localStorage with key:', dataKey);
                    const storedData = localStorage.getItem(dataKey);
                    console.log('Stored data found:', !!storedData);
                    console.log('Stored data length:', storedData ? storedData.length : 0);
                    
                    if (!storedData) {
                        console.error('No data found in localStorage with key:', dataKey);
                        this.showError(`No data found in localStorage with key: ${dataKey}`);
                        this.testSection.style.display = 'block';
                        return;
                    }
                    
                    console.log('Parsing stored data...');
                    this.formData = JSON.parse(storedData);
                    console.log('Parsed form data:', this.formData);
                    console.log('Form data keys:', Object.keys(this.formData));
                    console.log('Main features:', this.formData.main_features);
                    console.log('Main features type:', typeof this.formData.main_features);
                    console.log('Main features length:', this.formData.main_features ? this.formData.main_features.length : 'undefined');
                    console.log('Sub features:', this.formData.sub_features);
                    console.log('Sub features type:', typeof this.formData.sub_features);
                    console.log('Sub features length:', this.formData.sub_features ? this.formData.sub_features.length : 'undefined');
                    
                    // Validate that we have the essential data
                    if (!this.formData.projectName && !this.formData.clientName) {
                        console.error('Invalid form data - missing essential fields');
                        this.showError('Invalid form data. Please go back to the form and try again.');
                        this.testSection.style.display = 'block';
                        return;
                    }
                    
                    console.log('Form data loaded successfully, generating documents...');
                    localStorage.removeItem(dataKey); // Clean up
                    this.generateDocuments();
                    
                } catch (error) {
                    console.error('Error loading form data:', error);
                    this.showError(`Failed to load form data: ${error.message}`);
                    this.testSection.style.display = 'block';
                }
            }

            setupEventListeners() {
                this.submitBtn.addEventListener('click', () => this.submitSRS());
                this.printBtn.addEventListener('click', () => this.printCurrentDocument());
                this.downloadBtn.addEventListener('click', () => this.downloadCurrentDocument());
                
                // Tab switching
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tab = btn.dataset.tab;
                        this.switchTab(tab);
                    });
                });
                
                // Test button
                if (this.testBtn) {
                    this.testBtn.addEventListener('click', () => this.loadTestData());
                }
                
                // Refresh button
                if (this.refreshBtn) {
                    this.refreshBtn.addEventListener('click', () => this.forceRefresh());
                }
            }

            async generateDocuments() {
                if (!this.formData) {
                    this.showError('No form data available');
                    return;
                }

                try {
                    console.log('Starting AI-powered document generation...');
                    console.log('Form data:', this.formData);
                    
                    // Show loading state
                    this.loadingMessage.style.display = 'block';
                    this.loadingMessage.innerHTML = `
                        <div class="loading">
                            <h2>ü§ñ AI is generating your documents...</h2>
                            <p>Creating personalized SRS, Agreement, Pricing, Roadmap, and Summary</p>
                            <div class="loading-steps">
                                <div class="step">üìã Generating SRS Document...</div>
                                <div class="step">üìÑ Creating Project Agreement...</div>
                                <div class="step">üí∞ Calculating Pricing & Timeline...</div>
                                <div class="step">üó∫Ô∏è Building Developer Roadmap...</div>
                                <div class="step">üìä Preparing Project Summary...</div>
                            </div>
                        </div>
                    `;
                    
                    // Generate all documents using AI
                    const documents = await this.enhancedGemini.generateAllDocuments(this.formData);
                    
                    console.log('AI-generated documents:', documents);
                    
                    // Display the AI-generated content
                    this.srsDocument.innerHTML = documents.srsDocument.content || this.createSRSContent(this.formData);
                    this.contractDocument.innerHTML = documents.projectAgreement.content || this.createContractContent(this.formData);
                    this.pricingDocument.innerHTML = documents.pricingTimeline.content || this.createPricingContent(this.formData);
                    this.roadmapDocument.innerHTML = documents.developerRoadmap.content || this.createRoadmapContent(this.formData);
                    this.summaryDocument.innerHTML = documents.projectSummary.content || this.createSummaryContent(this.formData);
                    
                    // Hide loading and show documents
                    this.loadingMessage.style.display = 'none';
                    this.documentTabs.style.display = 'flex';
                    this.documentContent.style.display = 'block';
                    this.actionButtons.style.display = 'flex';
                    
                    console.log('All AI documents generated successfully');
                    
                } catch (error) {
                    console.error('Error generating AI documents:', error);
                    console.log('Falling back to static document generation...');
                    this.generateStaticDocuments();
                }
            }

            generateStaticDocuments() {
                try {
                    console.log('Generating static documents as fallback...');
                    
                    // Generate content using static methods
                    const srsContent = this.createSRSContent(this.formData);
                    const contractContent = this.createContractContent(this.formData);
                    const pricingContent = this.createPricingContent(this.formData);
                    const roadmapContent = this.createRoadmapContent(this.formData);
                    const summaryContent = this.createSummaryContent(this.formData);
                    
                    // Display content
                    this.srsDocument.innerHTML = srsContent;
                    this.contractDocument.innerHTML = contractContent;
                    this.pricingDocument.innerHTML = pricingContent;
                    this.roadmapDocument.innerHTML = roadmapContent;
                    this.summaryDocument.innerHTML = summaryContent;
                    
                    // Show documents
                    this.loadingMessage.style.display = 'none';
                    this.documentTabs.style.display = 'flex';
                    this.documentContent.style.display = 'block';
                    this.actionButtons.style.display = 'flex';
                    
                    console.log('Static documents generated successfully');
                    
                } catch (error) {
                    console.error('Error generating static documents:', error);
                    this.showError(`Failed to generate documents: ${error.message}`);
                }
            }

            createSRSContent(data) {
                console.log('Creating SRS content with data:', data);
                
                // Create a simple, clean HTML structure
                const content = `
                    <div class="srs-document">
                        <div class="document-header">
                            <h1>SOFTWARE REQUIREMENTS SPECIFICATION</h1>
                            <div class="project-info">
                                <div class="info-item">
                                    <strong>Project Name:</strong> ${data.projectName || 'Not specified'}
                                </div>
                                <div class="info-item">
                                    <strong>Client:</strong> ${data.clientName || 'Not specified'}
                                </div>
                                <div class="info-item">
                                    <strong>Document Version:</strong> 1.0 - ${new Date().toLocaleDateString()}
                                </div>
                                <div class="info-item">
                                    <strong>Prepared By:</strong> Suresh Yadav (Flutter Developer)
                                </div>
                            </div>
                        </div>

                        <div class="document-body">
                            <h2>1. Introduction</h2>
                            
                            <h3>1.1 Purpose</h3>
                            <p>This Software Requirements Specification (SRS) document describes the functional and non-functional requirements for the development of <strong>${data.projectName || 'the application'}</strong>.</p>
                            <p>The application is designed as a ${data.projectType || 'mobile application'} to ${data.projectDescription || 'meet specific business requirements'}.</p>
                            
                            <h3>1.2 Scope</h3>
                            <p>This SRS covers the complete development lifecycle of <strong>${data.projectName || 'the application'}</strong>, including:</p>
                            <ul>
                                <li>Functional requirements and specifications</li>
                                <li>User interface and user experience requirements</li>
                                <li>Performance and security requirements</li>
                                <li>Integration and deployment requirements</li>
                            </ul>

                            <h2>2. Overall Description</h2>
                            
                            <h3>2.1 Product Perspective</h3>
                            <p><strong>${data.projectName || 'The application'}</strong> is a ${data.projectType || 'standalone mobile application'} designed to serve ${data.targetAudience || 'end users'} in the ${data.primaryMarkets || 'target market'}.</p>

                            <h3>2.2 Product Functions</h3>
                            <p>The application shall provide the following core functionality:</p>
                            <ul>
                                ${this.generateFeatureList(data)}
                            </ul>

                            <h2>3. Specific Requirements</h2>
                            
                            <h3>3.1 Functional Requirements</h3>
                            <p>The following functional requirements define what the system shall do:</p>
                            ${this.generateFunctionalRequirements(data)}

                            <h3>3.2 Non-Functional Requirements</h3>
                            
                            <h4>3.2.1 Performance Requirements</h4>
                            <ul>
                                <li>Application startup time: Less than 3 seconds</li>
                                <li>Screen transition time: Less than 1 second</li>
                                <li>Data loading time: Less than 2 seconds for standard operations</li>
                                <li>Response time: Less than 500ms for user interactions</li>
                            </ul>

                            <h4>3.2.2 Security Requirements</h4>
                            <ul>
                                <li>All data transmission must use HTTPS/TLS encryption</li>
                                <li>Secure user authentication with password hashing</li>
                                <li>Role-based access control for different user types</li>
                                <li>Sensitive data must be encrypted at rest</li>
                            </ul>

                            <h2>4. Appendices</h2>
                            
                            <h3>4.1 Glossary</h3>
                            <ul>
                                <li><strong>SRS:</strong> Software Requirements Specification</li>
                                <li><strong>API:</strong> Application Programming Interface</li>
                                <li><strong>UI/UX:</strong> User Interface/User Experience</li>
                                <li><strong>Flutter:</strong> Google's UI toolkit for building natively compiled applications</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                console.log('SRS content generated, length:', content.length);
                return content;
            }

            generateFeatureList(data) {
                console.log('generateFeatureList called with data:', data);
                console.log('main_features:', data.main_features);
                console.log('main_features type:', typeof data.main_features);
                console.log('main_features length:', data.main_features ? data.main_features.length : 'undefined');
                
                if (!data.main_features || data.main_features.length === 0) {
                    console.log('No main features found, returning fallback');
                    return '<li>Core application functionality to be determined during detailed planning phase</li>';
                }
                
                console.log('Generating feature list for:', data.main_features);
                const featureList = data.main_features.map(feature => {
                    return `<li><strong>${this.getFeatureDisplayName(feature)}:</strong> ${this.getFeatureDescription(feature)}</li>`;
                }).join('');
                
                console.log('Generated feature list:', featureList);
                return featureList;
            }

            generateFunctionalRequirements(data) {
                if (!data.main_features || data.main_features.length === 0) {
                    return '<p>Functional requirements to be detailed during the design phase.</p>';
                }
                
                return data.main_features.map((feature, index) => {
                    return `
                        <div class="requirement-item">
                            <h4>FR-${index + 1}: ${this.getFeatureDisplayName(feature)}</h4>
                            <p>The system shall provide functionality to ${this.getFeatureDescription(feature)}. This includes all necessary user interface components, data validation, and error handling mechanisms.</p>
                        </div>
                    `;
                }).join('');
            }

            getFeatureDisplayName(feature) {
                const featureMap = {
                    'authentication': 'User Authentication & Login',
                    'user_management': 'User Profile Management',
                    'search_filter': 'Search & Filter System',
                    'payment_system': 'Payment & E-commerce',
                    'notifications': 'Push Notifications',
                    'messaging': 'In-App Messaging & Chat',
                    'location_services': 'Location & GPS Services',
                    'media_handling': 'Media & Content Handling',
                    'social_integration': 'Social Media Integration',
                    'analytics': 'Analytics & Reporting',
                    'offline_mode': 'Offline Functionality',
                    'admin_panel': 'Admin Panel & Dashboard'
                };
                return featureMap[feature] || feature;
            }

            getFeatureDescription(feature) {
                const descriptionMap = {
                    'authentication': 'authenticate and manage user accounts',
                    'user_management': 'manage user profiles and preferences',
                    'search_filter': 'search and filter content effectively',
                    'payment_system': 'process payments and manage transactions',
                    'notifications': 'receive push notifications',
                    'messaging': 'communicate with other users',
                    'location_services': 'access location-based features',
                    'media_handling': 'upload and manage media files',
                    'social_integration': 'integrate with social media platforms',
                    'analytics': 'view usage analytics and reports',
                    'offline_mode': 'use core features without internet',
                    'admin_panel': 'access administrative functions'
                };
                return descriptionMap[feature] || 'use this feature';
            }

            createContractContent(data) {
                let content = '<h1>PROJECT DEVELOPMENT AGREEMENT</h1>';
                
                content += '<div class="highlight-box">';
                content += `<p><strong>THIS AGREEMENT</strong> is made on ${new Date().toLocaleDateString()}, between:</p>`;
                content += '<p><strong>Developer:</strong> Suresh Yadav (Flutter Developer)</p>';
                content += `<p><strong>Client:</strong> ${data.clientName || 'Client Name'}</p>`;
                content += '</div>';

                content += '<h2>1. Scope of Work</h2>';
                content += `<p>Development of <strong>${data.projectName || 'the application'}</strong>, a ${data.projectType || 'mobile application'} with the following features:</p>`;
                content += '<ul>';
                if (data.main_features && data.main_features.length > 0) {
                    data.main_features.forEach(feature => {
                        content += `<li>${this.getFeatureDisplayName(feature)}</li>`;
                    });
                }
                content += '</ul>';

                content += '<h2>2. Project Phases & Deliverables</h2>';
                content += '<ul>';
                content += '<li><strong>Phase 1:</strong> UI/UX Design and Wireframes</li>';
                content += '<li><strong>Phase 2:</strong> MVP Development</li>';
                content += '<li><strong>Phase 3:</strong> Final Release and Testing</li>';
                content += '</ul>';

                content += '<h2>3. Timeline</h2>';
                content += `<p><strong>Estimated Duration:</strong> ${data.projectTimeline || 'To be determined'}</p>`;
                content += '<p><strong>Start Date:</strong> Upon agreement signing</p>';

                content += '<h2>4. Payment Terms</h2>';
                content += `<p><strong>Total Cost:</strong> ${data.budgetRange || 'To be discussed'}</p>`;
                content += '<ul>';
                content += '<li>30% on project initiation</li>';
                content += '<li>40% after MVP completion</li>';
                content += '<li>30% on final delivery</li>';
                content += '</ul>';

                content += '<h2>5. Intellectual Property</h2>';
                content += '<p>Client owns final code, assets, and designs after full payment. Developer may reuse open-source components.</p>';

                content += '<h2>6. Warranty & Support</h2>';
                content += '<p>3 months bug-fixing warranty post-deployment. Optional maintenance can be discussed separately.</p>';

                content += '<h2>7. Change Requests</h2>';
                content += '<p>Minor UI changes are included. New features or scope changes will be billed separately.</p>';

                content += '<h2>8. Termination</h2>';
                content += '<p>Either party may terminate with written notice. Work completed up to that point must be paid.</p>';

                content += '<h2>9. Governing Law</h2>';
                content += '<p>This contract is governed by the laws of Nepal.</p>';

                content += '<div class="highlight-box">';
                content += '<h3>Signatures</h3>';
                content += '<p><strong>Developer:</strong> Suresh Yadav</p>';
                content += '<p>Date: _________________</p>';
                content += '<p><strong>Client:</strong> _________________</p>';
                content += '<p>Date: _________________</p>';
                content += '</div>';

                return content;
            }

            createPricingContent(data) {
                let content = '<h1>Project Pricing & Timeline Estimation</h1>';
                
                content += '<div class="highlight-box">';
                content += '<h2>üí∞ Cost Estimation</h2>';
                content += '<p>Based on your selected features and requirements, here is the estimated project cost:</p>';
                content += '</div>';

                content += '<h2>Total Project Cost</h2>';
                content += '<div class="highlight-box">';
                content += '<p><strong>Estimated Total:</strong> $2,500 - $5,000 USD</p>';
                content += '<p><strong>Nepal Rupees:</strong> NPR 332,500 - NPR 665,000</p>';
                content += '<p><em>Note: Final pricing will be confirmed after detailed discussion</em></p>';
                content += '</div>';

                content += '<h2>Cost Breakdown</h2>';
                content += '<div class="table-container">';
                content += '<table class="srs-table">';
                content += '<thead><tr><th>Component</th><th>Estimated Hours</th><th>Rate (USD/hour)</th><th>Cost (USD)</th></tr></thead>';
                content += '<tbody>';
                content += '<tr><td>Development</td><td>80-120</td><td>$20</td><td>$1,600 - $2,400</td></tr>';
                content += '<tr><td>UI/UX Design</td><td>20-30</td><td>$15</td><td>$300 - $450</td></tr>';
                content += '<tr><td>Testing & QA</td><td>15-25</td><td>$15</td><td>$225 - $375</td></tr>';
                content += '<tr><td>Project Management</td><td>10-15</td><td>$15</td><td>$150 - $225</td></tr>';
                content += '<tr><td>Deployment & Setup</td><td>5-10</td><td>$20</td><td>$100 - $200</td></tr>';
                content += '</tbody>';
                content += '</table>';
                content += '</div>';

                content += '<h2>Feature-Based Pricing</h2>';
                content += '<div class="table-container">';
                content += '<table class="srs-table">';
                content += '<thead><tr><th>Feature</th><th>Complexity</th><th>Estimated Hours</th><th>Cost (USD)</th></tr></thead>';
                content += '<tbody>';
                
                if (data.main_features && data.main_features.length > 0) {
                    data.main_features.forEach(feature => {
                        const featureCost = this.getFeatureCost(feature);
                        content += `<tr><td>${this.getFeatureDisplayName(feature)}</td><td>${featureCost.complexity}</td><td>${featureCost.hours}</td><td>$${featureCost.cost}</td></tr>`;
                    });
                } else {
                    content += '<tr><td colspan="4">No features selected</td></tr>';
                }
                
                content += '</tbody>';
                content += '</table>';
                content += '</div>';

                content += '<h2>‚è∞ Timeline Estimation</h2>';
                content += '<div class="highlight-box">';
                content += '<p><strong>Total Duration:</strong> 6-12 weeks</p>';
                content += '<p><strong>Working Days:</strong> 30-60 days</p>';
                content += '</div>';

                content += '<h2>Project Phases</h2>';
                content += '<div class="table-container">';
                content += '<table class="srs-table">';
                content += '<thead><tr><th>Phase</th><th>Duration</th><th>Description</th><th>Deliverables</th></tr></thead>';
                content += '<tbody>';
                content += '<tr><td>Planning & Design</td><td>1-2 weeks</td><td>Project setup, UI/UX design, architecture planning</td><td>Wireframes, Design mockups, Technical architecture</td></tr>';
                content += '<tr><td>Development</td><td>4-8 weeks</td><td>Core feature development and integration</td><td>Working app, Feature implementations</td></tr>';
                content += '<tr><td>Testing & Deployment</td><td>1-2 weeks</td><td>Quality assurance, testing, and app store deployment</td><td>Tested app, App store submission</td></tr>';
                content += '</tbody>';
                content += '</table>';
                content += '</div>';

                content += '<h2>Payment Terms</h2>';
                content += '<div class="highlight-box">';
                content += '<ul>';
                content += '<li><strong>30%</strong> - Project initiation and contract signing</li>';
                content += '<li><strong>40%</strong> - After MVP completion and client approval</li>';
                content += '<li><strong>30%</strong> - Final delivery and app store submission</li>';
                content += '</ul>';
                content += '</div>';

                content += '<h2>Additional Considerations</h2>';
                content += '<ul>';
                content += '<li>All prices are in USD and based on Nepal market rates</li>';
                content += '<li>Final pricing may vary based on specific requirements</li>';
                content += '<li>Additional features or changes will be quoted separately</li>';
                content += '<li>3 months of bug-fixing warranty included</li>';
                content += '<li>Ongoing maintenance and updates available separately</li>';
                content += '</ul>';

                return content;
            }

            createRoadmapContent(data) {
                let content = '<h1>Developer Roadmap & Implementation Guide</h1>';
                
                content += '<div class="highlight-box">';
                content += '<h2>üó∫Ô∏è Project Development Roadmap</h2>';
                content += '<p>This roadmap provides a detailed guide for implementing your project with specific timelines and daily schedules.</p>';
                content += '</div>';

                content += '<h2>Technology Stack</h2>';
                content += '<div class="table-container">';
                content += '<table class="srs-table">';
                content += '<thead><tr><th>Category</th><th>Technology</th><th>Purpose</th></tr></thead>';
                content += '<tbody>';
                content += '<tr><td>Frontend</td><td>Flutter, Dart</td><td>Cross-platform mobile development</td></tr>';
                content += '<tr><td>Backend</td><td>Node.js, Express</td><td>API and server logic</td></tr>';
                content += '<tr><td>Database</td><td>MongoDB, Firebase</td><td>Data storage and management</td></tr>';
                content += '<tr><td>State Management</td><td>Provider, Bloc</td><td>Application state management</td></tr>';
                content += '<tr><td>Tools</td><td>VS Code, Android Studio, Git</td><td>Development environment</td></tr>';
                content += '</tbody>';
                content += '</table>';
                content += '</div>';

                content += '<h2>Development Phases</h2>';
                
                // Phase 1: Project Setup
                content += '<h3>Phase 1: Project Setup & Planning (Week 1)</h3>';
                content += '<div class="highlight-box">';
                content += '<h4>Day 1-2: Project Initialization</h4>';
                content += '<ul>';
                content += '<li><strong>9:00 AM - 12:00 PM:</strong> Initialize Flutter project, set up Git repository</li>';
                content += '<li><strong>1:00 PM - 5:00 PM:</strong> Configure development environment, install dependencies</li>';
                content += '</ul>';
                content += '<h4>Day 3-4: Architecture Planning</h4>';
                content += '<ul>';
                content += '<li><strong>9:00 AM - 12:00 PM:</strong> Design application architecture and folder structure</li>';
                content += '<li><strong>1:00 PM - 5:00 PM:</strong> Set up state management and routing</li>';
                content += '</ul>';
                content += '<h4>Day 5: UI/UX Design</h4>';
                content += '<ul>';
                content += '<li><strong>9:00 AM - 12:00 PM:</strong> Create wireframes and mockups</li>';
                content += '<li><strong>1:00 PM - 5:00 PM:</strong> Design system and component library</li>';
                content += '</ul>';
                content += '</div>';

                // Phase 2: Core Development
                content += '<h3>Phase 2: Core Development (Weeks 2-6)</h3>';
                
                if (data.main_features && data.main_features.length > 0) {
                    data.main_features.forEach((feature, index) => {
                        const featureInfo = this.getFeatureRoadmap(feature);
                        content += `<h4>Feature ${index + 1}: ${this.getFeatureDisplayName(feature)}</h4>`;
                        content += '<div class="highlight-box">';
                        content += `<p><strong>Duration:</strong> ${featureInfo.duration} days</p>`;
                        content += `<p><strong>Complexity:</strong> ${featureInfo.complexity}</p>`;
                        content += '<h5>Implementation Steps:</h5>';
                        content += '<ol>';
                        featureInfo.steps.forEach(step => {
                            content += `<li><strong>${step.time}:</strong> ${step.description}</li>`;
                        });
                        content += '</ol>';
                        content += '</div>';
                    });
                }

                // Phase 3: Testing & Deployment
                content += '<h3>Phase 3: Testing & Deployment (Week 7-8)</h3>';
                content += '<div class="highlight-box">';
                content += '<h4>Week 7: Testing & Quality Assurance</h4>';
                content += '<ul>';
                content += '<li><strong>Day 1-2:</strong> Unit testing and code review</li>';
                content += '<li><strong>Day 3-4:</strong> Integration testing and bug fixes</li>';
                content += '<li><strong>Day 5:</strong> User acceptance testing</li>';
                content += '</ul>';
                content += '<h4>Week 8: Deployment & Launch</h4>';
                content += '<ul>';
                content += '<li><strong>Day 1-2:</strong> App store preparation and submission</li>';
                content += '<li><strong>Day 3-4:</strong> Production deployment and monitoring</li>';
                content += '<li><strong>Day 5:</strong> Launch and initial support</li>';
                content += '</ul>';
                content += '</div>';

                content += '<h2>Best Practices & Guidelines</h2>';
                content += '<div class="highlight-box">';
                content += '<ul>';
                content += '<li>Follow Flutter best practices and coding conventions</li>';
                content += '<li>Implement proper error handling and logging</li>';
                content += '<li>Write comprehensive unit tests for critical functions</li>';
                content += '<li>Use version control effectively with meaningful commit messages</li>';
                content += '<li>Regular code reviews and refactoring</li>';
                content += '<li>Optimize for performance and battery life</li>';
                content += '<li>Ensure accessibility compliance</li>';
                content += '</ul>';
                content += '</div>';

                content += '<h2>Common Challenges & Solutions</h2>';
                content += '<div class="table-container">';
                content += '<table class="srs-table">';
                content += '<thead><tr><th>Challenge</th><th>Solution</th><th>Prevention</th></tr></thead>';
                content += '<tbody>';
                content += '<tr><td>State Management Complexity</td><td>Use Provider or Bloc pattern</td><td>Plan state structure early</td></tr>';
                content += '<tr><td>Platform-specific Issues</td><td>Test on both iOS and Android</td><td>Use platform-specific code when needed</td></tr>';
                content += '<tr><td>Performance Issues</td><td>Profile and optimize</td><td>Follow performance best practices</td></tr>';
                content += '<tr><td>Third-party Integration</td><td>Use well-maintained packages</td><td>Research and test integrations early</td></tr>';
                content += '</tbody>';
                content += '</table>';
                content += '</div>';

                return content;
            }

            getFeatureCost(feature) {
                const featureCosts = {
                    'authentication': { complexity: 'Medium', hours: '16', cost: '320' },
                    'user_management': { complexity: 'Low', hours: '12', cost: '240' },
                    'search_filter': { complexity: 'Low', hours: '8', cost: '160' },
                    'payment_system': { complexity: 'High', hours: '24', cost: '480' },
                    'notifications': { complexity: 'Medium', hours: '10', cost: '200' },
                    'messaging': { complexity: 'High', hours: '20', cost: '400' },
                    'location_services': { complexity: 'Medium', hours: '12', cost: '240' },
                    'media_handling': { complexity: 'Medium', hours: '16', cost: '320' },
                    'social_integration': { complexity: 'Medium', hours: '14', cost: '280' },
                    'analytics': { complexity: 'Low', hours: '8', cost: '160' },
                    'offline_mode': { complexity: 'High', hours: '18', cost: '360' },
                    'admin_panel': { complexity: 'High', hours: '20', cost: '400' }
                };
                
                return featureCosts[feature] || { complexity: 'Medium', hours: '10', cost: '200' };
            }

            getFeatureRoadmap(feature) {
                const roadmaps = {
                    'authentication': {
                        duration: 3,
                        complexity: 'Medium',
                        steps: [
                            { time: 'Day 1, 9:00 AM - 12:00 PM', description: 'Design authentication UI and user flows' },
                            { time: 'Day 1, 1:00 PM - 5:00 PM', description: 'Implement login and registration forms' },
                            { time: 'Day 2, 9:00 AM - 12:00 PM', description: 'Set up backend authentication API' },
                            { time: 'Day 2, 1:00 PM - 5:00 PM', description: 'Implement password reset functionality' },
                            { time: 'Day 3, 9:00 AM - 12:00 PM', description: 'Add social login integration' },
                            { time: 'Day 3, 1:00 PM - 5:00 PM', description: 'Testing and security validation' }
                        ]
                    },
                    'user_management': {
                        duration: 2,
                        complexity: 'Low',
                        steps: [
                            { time: 'Day 1, 9:00 AM - 12:00 PM', description: 'Design user profile interface' },
                            { time: 'Day 1, 1:00 PM - 5:00 PM', description: 'Implement profile editing functionality' },
                            { time: 'Day 2, 9:00 AM - 12:00 PM', description: 'Add profile picture upload' },
                            { time: 'Day 2, 1:00 PM - 5:00 PM', description: 'Implement user preferences and settings' }
                        ]
                    },
                    'payment_system': {
                        duration: 5,
                        complexity: 'High',
                        steps: [
                            { time: 'Day 1, 9:00 AM - 12:00 PM', description: 'Research and select payment gateway' },
                            { time: 'Day 1, 1:00 PM - 5:00 PM', description: 'Set up payment gateway integration' },
                            { time: 'Day 2, 9:00 AM - 12:00 PM', description: 'Design payment flow UI' },
                            { time: 'Day 2, 1:00 PM - 5:00 PM', description: 'Implement payment processing logic' },
                            { time: 'Day 3, 9:00 AM - 12:00 PM', description: 'Add transaction history and receipts' },
                            { time: 'Day 3, 1:00 PM - 5:00 PM', description: 'Implement refund and cancellation' },
                            { time: 'Day 4, 9:00 AM - 12:00 PM', description: 'Security testing and validation' },
                            { time: 'Day 4, 1:00 PM - 5:00 PM', description: 'PCI compliance implementation' },
                            { time: 'Day 5, 9:00 AM - 5:00 PM', description: 'End-to-end testing and bug fixes' }
                        ]
                    }
                };
                
                return roadmaps[feature] || {
                    duration: 2,
                    complexity: 'Medium',
                    steps: [
                        { time: 'Day 1, 9:00 AM - 5:00 PM', description: 'Feature implementation and testing' },
                        { time: 'Day 2, 9:00 AM - 5:00 PM', description: 'Integration and final testing' }
                    ]
                };
            }

            createSummaryContent(data) {
                let content = '<h1>Project Summary & Next Steps</h1>';
                
                content += '<h2>Project Overview</h2>';
                content += '<div class="highlight-box">';
                content += `<p><strong>Project Name:</strong> ${data.projectName || 'Not specified'}</p>`;
                content += `<p><strong>Client:</strong> ${data.clientName || 'Not specified'}</p>`;
                content += `<p><strong>Project Type:</strong> ${data.projectType || 'Not specified'}</p>`;
                content += `<p><strong>Target Platforms:</strong> ${Array.isArray(data.platforms) ? data.platforms.join(', ') : data.platforms || 'Not specified'}</p>`;
                content += `<p><strong>Timeline:</strong> ${data.projectTimeline || 'To be determined'}</p>`;
                content += `<p><strong>Budget Range:</strong> ${data.budgetRange || 'To be discussed'}</p>`;
                content += '</div>';

                content += '<h2>Key Features Summary</h2>';
                content += '<ul>';
                if (data.main_features && data.main_features.length > 0) {
                    data.main_features.forEach(feature => {
                        content += `<li><strong>${this.getFeatureDisplayName(feature)}</strong></li>`;
                    });
                } else {
                    content += '<li>Features to be determined during detailed planning</li>';
                }
                content += '</ul>';

                content += '<h2>Technical Requirements</h2>';
                content += '<ul>';
                content += `<li><strong>Backend:</strong> ${data.backendRequirements || 'To be determined'}</li>`;
                content += `<li><strong>Integrations:</strong> ${Array.isArray(data.integrations) ? data.integrations.join(', ') : data.integrations || 'None specified'}</li>`;
                content += `<li><strong>Security:</strong> ${Array.isArray(data.security) ? data.security.join(', ') : data.security || 'Standard security measures'}</li>`;
                content += '</ul>';

                content += '<h2>Next Steps</h2>';
                content += '<ol>';
                content += '<li><strong>Review Documents:</strong> Carefully review the SRS and contract</li>';
                content += '<li><strong>Sign Contract:</strong> Sign the project agreement to proceed</li>';
                content += '<li><strong>Initial Payment:</strong> Make the initial payment (30%)</li>';
                content += '<li><strong>Project Kickoff:</strong> Schedule project kickoff meeting</li>';
                content += '<li><strong>Development Begins:</strong> Start the development process</li>';
                content += '</ol>';

                content += '<h2>Contact Information</h2>';
                content += '<div class="highlight-box">';
                content += '<p><strong>Developer:</strong> Suresh Yadav</p>';
                content += '<p><strong>Email:</strong> Available through contact form</p>';
                content += '<p><strong>Specialization:</strong> Flutter Development, Full-Stack Development</p>';
                content += '</div>';

                return content;
            }

            getFeatureDisplayName(feature) {
                const featureMap = {
                    'authentication': 'User Authentication & Login',
                    'user_management': 'User Profile Management',
                    'search_filter': 'Search & Filter System',
                    'payment_system': 'Payment & E-commerce',
                    'notifications': 'Push Notifications',
                    'messaging': 'In-App Messaging & Chat',
                    'location_services': 'Location & GPS Services',
                    'media_handling': 'Media & Content Handling',
                    'social_integration': 'Social Media Integration',
                    'analytics': 'Analytics & Reporting',
                    'offline_mode': 'Offline Functionality',
                    'admin_panel': 'Admin Panel & Dashboard'
                };
                return featureMap[feature] || feature;
            }

            getFeatureDescription(feature) {
                const descriptionMap = {
                    'authentication': 'authenticate and manage user accounts securely',
                    'user_management': 'manage user profiles and preferences',
                    'search_filter': 'search and filter content effectively',
                    'payment_system': 'process payments and manage transactions',
                    'notifications': 'receive push notifications',
                    'messaging': 'communicate with other users',
                    'location_services': 'access location-based features',
                    'media_handling': 'upload and manage media files',
                    'social_integration': 'integrate with social media platforms',
                    'analytics': 'view usage analytics and reports',
                    'offline_mode': 'use core features without internet connection',
                    'admin_panel': 'access administrative functions'
                };
                return descriptionMap[feature] || 'use this feature';
            }

            switchTab(tabName) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');
            }

            getCurrentDocument() {
                const activeTab = document.querySelector('.tab-btn.active');
                const tabName = activeTab ? activeTab.dataset.tab : 'srs';
                
                switch(tabName) {
                    case 'contract':
                        return this.contractDocument;
                    case 'pricing':
                        return this.pricingDocument;
                    case 'roadmap':
                        return this.roadmapDocument;
                    case 'summary':
                        return this.summaryDocument;
                    default:
                        return this.srsDocument;
                }
            }

            printCurrentDocument() {
                const currentDoc = this.getCurrentDocument();
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Document Print</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                            h1 { color: #333; border-bottom: 2px solid #333; }
                            h2 { color: #666; border-bottom: 1px solid #666; }
                            h3 { color: #888; }
                            .highlight-box { background: #f5f5f5; padding: 15px; border: 1px solid #ddd; margin: 20px 0; }
                        </style>
                    </head>
                    <body>
                        ${currentDoc.innerHTML}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            downloadCurrentDocument() {
                const currentDoc = this.getCurrentDocument();
                const activeTab = document.querySelector('.tab-btn.active');
                const tabName = activeTab ? activeTab.dataset.tab : 'srs';
                
                const blob = new Blob([`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${tabName.toUpperCase()} Document - ${this.formData.projectName || 'Project'}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                            h1 { color: #333; border-bottom: 2px solid #333; }
                            h2 { color: #666; border-bottom: 1px solid #666; }
                            h3 { color: #888; }
                            .highlight-box { background: #f5f5f5; padding: 15px; border: 1px solid #ddd; margin: 20px 0; }
                        </style>
                    </head>
                    <body>
                        ${currentDoc.innerHTML}
                    </body>
                    </html>
                `], { type: 'text/html' });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${tabName.toUpperCase()}_${this.formData.projectName || 'Project'}_${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            submitSRS() {
                this.submitBtn.disabled = true;
                this.submitBtn.innerHTML = '<span class="btn-icon">‚è≥</span><span class="btn-text">Submitting...</span>';

                const emailContent = this.createEmailContent();
                this.submitToWeb3Forms(emailContent);
            }

            createEmailContent() {
                let content = `NEW SRS FORM SUBMISSION\n\n`;
                content += `Project Details:\n`;
                content += `- Project Name: ${this.formData.projectName || 'Not specified'}\n`;
                content += `- Client: ${this.formData.clientName || 'Not specified'}\n`;
                content += `- Project Type: ${this.formData.projectType || 'Not specified'}\n`;
                content += `- Description: ${this.formData.projectDescription || 'Not specified'}\n\n`;
                
                content += `Target Audience: ${this.formData.targetAudience || 'Not specified'}\n`;
                content += `Primary Markets: ${this.formData.primaryMarkets || 'Not specified'}\n`;
                content += `Platforms: ${Array.isArray(this.formData.platforms) ? this.formData.platforms.join(', ') : this.formData.platforms || 'Not specified'}\n\n`;
                
                content += `Selected Features:\n`;
                if (this.formData.main_features && this.formData.main_features.length > 0) {
                    this.formData.main_features.forEach(feature => {
                        content += `- ${this.getFeatureDisplayName(feature)}\n`;
                    });
                } else {
                    content += `- No features selected\n`;
                }
                content += `\n`;
                
                content += `Timeline: ${this.formData.projectTimeline || 'Not specified'}\n`;
                content += `Budget Range: ${this.formData.budgetRange || 'Not specified'}\n`;
                content += `Development Phase: ${this.formData.developmentPhase || 'Not specified'}\n\n`;
                
                content += `Additional Notes: ${this.formData.additionalNotes || 'None'}\n\n`;
                content += `---\n`;
                content += `This SRS was generated and submitted through the online form.`;
                
                return content;
            }

            async submitToWeb3Forms(emailContent) {
                try {
                    const formData = new FormData();
                    formData.append('access_key', '7f6edf0a-47e0-49a4-bebf-2a8be167a68b');
                    formData.append('subject', 'New SRS Form Submission - Flutter Project');
                    formData.append('from_name', this.formData.clientName || 'SRS Form');
                    formData.append('message', emailContent);
                    formData.append('redirect', 'true');
                    formData.append('redirect_url', '../index.html?submitted=true');

                    const response = await fetch('https://api.web3forms.com/submit', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        this.showToast('SRS submitted successfully! I\'ll review your requirements and get back to you soon.', 'success');
                        setTimeout(() => {
                            window.location.href = '../index.html?submitted=true';
                        }, 3000);
                    } else {
                        throw new Error('Failed to submit form');
                    }
                } catch (error) {
                    console.error('Form submission error:', error);
                    
                    // Fallback for CORS issues
                    if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                        const tempForm = document.createElement('form');
                        tempForm.method = 'POST';
                        tempForm.action = 'https://api.web3forms.com/submit';
                        tempForm.target = '_blank';
                        
                        for (let [key, value] of formData.entries()) {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = key;
                            input.value = value;
                            tempForm.appendChild(input);
                        }
                        
                        document.body.appendChild(tempForm);
                        tempForm.submit();
                        document.body.removeChild(tempForm);
                        
                        this.showToast('SRS submitted successfully! Check your email.', 'success');
                    } else {
                        this.showToast(`Submission failed: ${error.message}`, 'error');
                    }
                } finally {
                    this.submitBtn.disabled = false;
                    this.submitBtn.innerHTML = '<span class="btn-icon">üìß</span><span class="btn-text">Submit SRS & Get Contract</span>';
                }
            }

            showTestButton() {
                this.loadingMessage.style.display = 'none';
                this.testSection.style.display = 'block';
            }

            loadTestData() {
                this.formData = {
                    projectName: 'Test Mobile App',
                    clientName: 'Test Client',
                    clientEmail: 'test@example.com',
                    projectType: 'Mobile Application',
                    projectDescription: 'A test mobile application for demonstration purposes',
                    targetAudience: 'General users',
                    primaryMarkets: 'Global',
                    platforms: ['Android', 'iOS'],
                    main_features: ['authentication', 'user_management', 'search_filter', 'notifications'],
                    projectTimeline: '3-6 months',
                    budgetRange: '$5000-$10000',
                    developmentPhase: 'Full Development',
                    additionalNotes: 'This is test data for demonstration'
                };
                
                this.testSection.style.display = 'none';
                this.generateDocuments();
            }

            forceRefresh() {
                console.log('Force refresh requested...');
                
                // Clear all localStorage
                localStorage.clear();
                console.log('localStorage cleared');
                
                // Clear any cached data
                this.formData = null;
                
                // Force page reload with cache busting
                const url = new URL(window.location);
                url.searchParams.set('t', Date.now().toString());
                window.location.href = url.toString();
            }

            showError(message) {
                this.loadingMessage.style.display = 'none';
                this.errorMessage.style.display = 'block';
                this.errorMessage.querySelector('p').textContent = message;
            }

            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast toast-${type}`;
                toast.style.display = 'block';
                
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 4000);
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new SRSPreview();
        });
    </script>
</body>
</html>